<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>smart editor</title>
    <!--    element-->
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.7/lib/theme-chalk/index.css">

    <script src="./closure/goog/base.js"></script>
    <script src="./blockly_compressed.js"></script>
    <script src="./blocks_compressed.js"></script>
    <script src="solidity_compressed.js"></script>

    <script src="blocks/myGenerate/basicFunction.js" charset="UTF-8"></script>
    <script src="blocks/myGenerate/fieldType.js" charset="UTF-8"></script>
    <script src="blocks/myGenerate/functionType.js" charset="UTF-8"></script>
    <script src="blocks/myGenerate/functionQualifier.js" charset="UTF-8"></script>
    <script src="blocks/myGenerate/functionStatement.js" charset="UTF-8"></script>

    <script src="./msg/js/zh-hans.js"></script>
    <script src="./msg/js/en.js"></script>

    <script src="generators/myGenerate/basicFunction.js"></script>
    <script src="generators/myGenerate/fieldType.js"></script>
    <script src="generators/myGenerate/functionType.js"></script>
    <script src="generators/myGenerate/functionQualifier.js"></script>
    <script src="generators/myGenerate/functionStatement.js"></script>

    <script src="./jquery-3.4.1.js"></script>
    <script src="./storage.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.7/lib/theme-chalk/index.css">
</head>
<body>
<table style="width: 100%; height: 850px;">
    <tr>
        <td style="width: 74%;height: 100%;">
            <div id="blocklyDiv" style="height: 100%; width: 100%;"></div>
        </td>
        <td style="width: 1%">
        </td>
        <td style="width: 25%;height: 95%;">
            <textarea id="textarea" style="width:100%;height:100%;float:right"></textarea>
        </td>
    </tr>
</table>
<ul style="width: 100%;height: 5%;">
    <!--    <li style="display: inline-block;float: left">-->
    <!--        <a id="xml-download-block" href title="save blocks">-->
    <!--            save blocks-->
    <!--        </a>-->
    <!--    </li>-->
    <div id="app">
        <li style="display: inline-block;float: left">
            <el-button size="small" type="primary" @click="saveBlocks()">Save Blocks</el-button>
        </li>
        <li style="display: inline-block;float: left;margin-left: 30px">
            <!--            action="https://jsonplaceholder.typicode.com/posts/"-->
            <el-upload
                    class="upload-demo"
                    ref="uploadDemo"
                    action="https://jsonplaceholder.typicode.com/posts/"
                    :on-preview="handlePreview"
                    :on-remove="handleRemove"
                    :before-remove="beforeRemove"
                    :http-request="uploadBpmn"
                    multiple
                    :limit="3"
                    :on-exceed="handleExceed"
                    :file-list="fileList">
                <el-button size="small" type="primary">点击上传</el-button>
                <!--                <div slot="tip" class="el-upload__tip">请上传想要保存的流程图</div>-->
            </el-upload>
            <el-dialog title="保存工作区" :visible.sync="dialogFormVisible">
                <el-form :model="form">
                    <el-form-item label="文件名称" :label-width="formLabelWidth">
                        <el-input v-model="form.name" autocomplete="off"></el-input>
                    </el-form-item>
                </el-form>
                <div slot="footer" class="dialog-footer">
                    <el-button @click="dialogFormVisible = false">取 消</el-button>
                    <el-button type="primary" @click="saveWorkspace()">确 定</el-button>
                </div>
            </el-dialog>
        </li>

    </div>
</ul>

<xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category name="函数类型" colour="230">
        <block type="function"></block>
        <block type="construct"></block>
        <block type="event"></block>
        <block type="fall_back"></block>
    </category>
    <category name="函数修饰符" colour="0">
        <block type="function_visibility"></block>
        <block type="function_type"></block>
    </category>
    <category name="基本的复用功能块" colour="165">
        <block type="set_contract_owner"></block>
        <block type="get_value"></block>
        <block type="transfer"></block>
        <block type="require"></block>
        <block type="destroy_contract"></block>
    </category>
    <category name="其他函数语句" colour="30">
        <block type="assignment"></block>
        <block type="ordinary"></block>
    </category>
    <category name="属性块" colour="270">
        <category name="嵌套类型">
            <block type="basic_type_no_name"></block>
            <block type="nest_mapping_array"></block>
        </category>
        <block type="basic_type"></block>
        <block type="special_type"></block>
        <block type="nest_struct"></block>
    </category>
    <sep></sep>
    <sep></sep>
    <category name="Logic" colour="%{BKY_LOGIC_HUE}">
        <category name="If">
            <block type="controls_if"></block>
            <block type="controls_if">
                <mutation else="1"></mutation>
            </block>
            <block type="controls_if">
                <mutation elseif="1" else="1"></mutation>
            </block>
        </category>
        <category name="Boolean">
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
            <block type="logic_null"></block>
            <!--            <block type="logic_ternary"></block>-->
        </category>
    </category>


    <category name="Loops" colour="%{BKY_LOOPS_HUE}">
        <block type="controls_repeat_ext">
            <value name="TIMES">
                <block type="math_number">
                    <field name="NUM">10</field>
                </block>
            </value>
        </block>
        <block type="controls_whileUntil"></block>
        <block type="controls_for">
            <field name="VAR">i</field>
            <value name="FROM">
                <block type="math_number">
                    <field name="NUM">1</field>
                </block>
            </value>
            <value name="TO">
                <block type="math_number">
                    <field name="NUM">10</field>
                </block>
            </value>
            <value name="BY">
                <block type="math_number">
                    <field name="NUM">1</field>
                </block>
            </value>
        </block>
        <!--        <block type="controls_forEach"></block>-->
        <block type="controls_flow_statements"></block>
    </category>


    <category name="Math" colour="%{BKY_MATH_HUE}">
        <block type="math_number">
            <field name="NUM">123</field>
        </block>
        <block type="math_arithmetic"></block>
        <!--        <block type="math_single"></block>-->
        <!--        <block type="math_trig"></block>-->
        <!--        <block type="math_constant"></block>-->
        <block type="math_number_property"></block>
        <!--        <block type="math_round"></block>-->
        <!--        <block type="math_on_list"></block>-->
        <block type="math_modulo"></block>
        <!--        <block type="math_random_int">-->
        <!--            <value name="FROM">-->
        <!--                <block type="math_number">-->
        <!--                    <field name="NUM">1</field>-->
        <!--                </block>-->
        <!--            </value>-->
        <!--            <value name="TO">-->
        <!--                <block type="math_number">-->
        <!--                    <field name="NUM">100</field>-->
        <!--                </block>-->
        <!--            </value>-->
        <!--        </block>-->
        <!--        <block type="math_random_float"></block>-->
        <!--        <block type="math_atan2"></block>-->
    </category>
    <category name="文本" colour="45">
        <block type="text"></block>
    </category>

</xml>

<script src="workspace.js"></script>
</body>

<!-- 引入组件库 -->
<script src="https://cdn.staticfile.org/vue/2.2.2/vue.min.js"></script>
<script src="https://unpkg.com/element-ui@2.15.7/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/vue-clipboard2/0.3.3/vue-clipboard.js"></script>

<script>
    //恢复工作区的块
    // setTimeout(BlocklyStorage.restoreBlocks, 0);

    $('#xml-download-block').click(function () {
        var xml = Blockly.Xml.workspaceToDom(workspace);
        let data = Blockly.Xml.domToText(xml);
        console.log('downloadXml:' + data);
        setEncoded($('#xml-download-block'), "blocks.xml", data);
    })

    function showCode() {
        var codes = Blockly.Solidity.workspaceToCode(workspace);
        console.log(codes);
        document.getElementById('textarea').value = codes;
        // alert(codes);
    }

    function setEncoded(link, name, data) {
        //编码为URI格式
        var encodedData = encodeURIComponent(data);

        if (data) {
            link.addClass('active').attr({
                'href': 'data:application/blocks-xml;charset=UTF-8,' + encodedData,
                'download': name
            });
        } else {
            link.removeClass('active');
        }
    }

</script>

<script>
    var Main = {
        data() {
            return {
                fileList: [],
                dialogVisible_flow: false,
                dialog_data: "",
                dialogFormVisible: false,
                form: {
                    name: '',
                },
                formLabelWidth: '120px'
            };
        },
        mounted() {
            window.dialog = this.dialogTest;    // 方法赋值给window
        },
        methods: {
            uploadBpmn(param) {
                //设置alert弹窗样式不显示 域名
                (function () {
                    window.alert = function (name) {
                        var iframe = document.createElement("IFRAME");
                        iframe.style.display = "none";
                        iframe.setAttribute("src", 'data:text/plain');
                        document.documentElement.appendChild(iframe);
                        window.frames[0].window.alert(name);
                        iframe.parentNode.removeChild(iframe);
                    }
                })();
                let data = param.file;
                console.log(data);
                var reader = new FileReader();
                reader.onload = function (event) {
                    var xml = Blockly.Xml.textToDom(event.target.result);
                    console.log(xml)
                    Blockly.Xml.clearWorkspaceAndLoadFromXml(xml, workspace);
                };

                reader.readAsText(data);
            },
            async dialogTest(data) {
                this.dialog_data = data;
                this.dialogVisible_flow = true;
            },
            saveBlocks() {
                var xml = Blockly.Xml.workspaceToDom(workspace);
                let data = Blockly.Xml.domToText(xml);
                // console.log('downloadXml:' + data);
                const a = document.createElement('a'); // 创建a标签
                var encodedData = encodeURIComponent(data);
                a.setAttribute('href', 'data:application/blocks-xml;charset=UTF-8,' + encodedData);
                a.setAttribute('download', 'blocks.xml');
                a.click();// 自执行点击事件
            },
            copyFileId() {
                console.log("执行复制");
                var e = document.createElement("input");
                console.log(this.dialog_data)
                e.value = this.dialog_data;
                console.log(e);
                e.select(); // 选择对象
                document.execCommand("Copy"); // 执行浏览器复制命令
                this.dialogVisible_flow = false;
            },
            handleRemove(file, fileList) {
                console.log(file, fileList);
            },
            handlePreview(file) {
                console.log(file);
            },
            handleExceed(files, fileList) {
                this.$message.warning(`当前限制选择 3 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length + fileList.length} 个文件`);
            },
            beforeRemove(file, fileList) {
                return this.$confirm(`确定移除 ${file.name}？`);
            },
            saveWorkspace() {
                var file_name = this.form.name;
                var xml = BlocklyStorage.backupOnUnload();
                console.log(fileName + "===" + xml);
                this.dialogFormVisible = false;
                this.axios.post('http://', {
                    fileName: file_name,
                    fileContent: xml
                }).then(res => {
                    if (res.data.code === 200) {
                        alert("保存成功")
                    } else if (res.data.code === 400) {
                        alert(res.data.msg);
                    }
                }).catch(rees => {
                    console.log("保存失败")
                })
                // const formData = new FormData();
                // formData.append('file', param.file)
                //
                // const config = {
                //     headers: {"Content-Type": "multipart/form-data"}
                // };
                // axios.post("http://localhost:9014/api/bpmn/upload", formData, config).then(res => {
                //     console.log(res);
                //     if (res.data.code === 200) {
                //         this.dialogVisible_flow = true;
                //         this.dialog_data = res.data.data
                //         // alert("上传的bpmn流程图id\n" + res.data.data)
                //         this.$refs.uploadDemo.clearFiles();
                //     } else if (res.data.code === 403) {
                //         alert(res.data.msg)
                //         this.$refs.uploadDemo.clearFiles();
                //     }
                // }).catch(response => {
                //     console.log('图片上传失败')
                // });
            }
        }
    }
    Vue.use(VueClipboard)
    var Ctor = Vue.extend(Main)
    new Ctor().$mount('#app')
</script>
</html>
